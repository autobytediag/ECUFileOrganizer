name: Build & Release EXE

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Compute next version from tags
        id: bump
        shell: bash
        run: |
          # Get latest version tag (e.g. v1.22)
          LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            NEW="1.0"
          else
            # Strip 'v' prefix and increment last number
            OLD="${LATEST_TAG#v}"
            MAJOR=$(echo "$OLD" | cut -d. -f1)
            MINOR=$(echo "$OLD" | cut -d. -f2)
            NEW="${MAJOR}.$((MINOR + 1))"
          fi
          echo "Version: $NEW (previous tag: $LATEST_TAG)"
          echo "new=$NEW" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEW" >> "$GITHUB_OUTPUT"

      - name: Inject version into build
        shell: python
        run: |
          import re
          version = "${{ steps.bump.outputs.new }}"
          with open("ecu_file_organizer/constants.py") as f:
              content = f.read()
          content = re.sub(r'APP_VERSION\s*=\s*"[^"]*"', f'APP_VERSION = "{version}"', content)
          with open("ecu_file_organizer/constants.py", "w") as f:
              f.write(content)
          print(f"Injected version {version} into constants.py (build only, not committed)")

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.bump.outputs.tag }}
          git push origin ${{ steps.bump.outputs.tag }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Build EXE with Nuitka
        uses: Nuitka/Nuitka-Action@main
        with:
          nuitka-version: main
          script-name: ecu_file_organizer.py
          mode: app
          disable-console: true
          windows-icon-from-ico: app_icon.ico
          enable-plugins: pyqt6
          assume-yes-for-downloads: true
          nofollow-import-to: |
            PyQt6.QtWebEngine
            PyQt6.QtWebEngineCore
            PyQt6.QtWebEngineWidgets
            PyQt6.QtWebChannel
            PyQt6.QtWebSockets
            PyQt6.Qt3DCore
            PyQt6.Qt3DRender
            PyQt6.Qt3DInput
            PyQt6.QtMultimedia
            PyQt6.QtMultimediaWidgets
            PyQt6.QtBluetooth
            PyQt6.QtNfc
            PyQt6.QtSensors
            PyQt6.QtQuick
            PyQt6.QtQuickWidgets
            PyQt6.QtQml
            PyQt6.QtDesigner
            PyQt6.QtHelp
            PyQt6.QtTest
            PyQt6.QtNetwork
            PyQt6.QtNetworkAuth
            PyQt6.QtOpenGL
            PyQt6.QtOpenGLWidgets
            PyQt6.QtPdf
            PyQt6.QtSvg
            PyQt6.QtSvgWidgets
            PyQt6.QtXml
            PyQt6.QtSql
            PyQt6.QtDBus
            PyQt6.QtRemoteObjects
            PyQt6.QtSerialPort
            PyQt6.QtPositioning
            PyQt6.QtLocation
            PyQt6.QtTextToSpeech
            PyQt6.QtSpatialAudio
            tkinter
            unittest
            pydoc
            lib2to3
            xmlrpc
            multiprocessing
          output-file: ECU_File_Organizer

      - name: Rename EXE with version
        run: |
          mkdir -p dist
          move build\ECU_File_Organizer.exe "dist\ECU_File_Organizer_v${{ steps.bump.outputs.new }}.exe"
        shell: cmd

      - name: Show EXE size
        run: |
          dir dist\*.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ECU_File_Organizer_v${{ steps.bump.outputs.new }}
          path: dist/*.exe
          include-hidden-files: true

      - name: Generate changelog from PRs and commits
        id: changelog
        shell: bash
        run: |
          # Find the previous tag (exclude current)
          CURRENT_TAG="${{ steps.bump.outputs.tag }}"
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n 1)

          if [ -z "$PREV_TAG" ]; then
            # No previous tag - use all commits
            RANGE="HEAD"
          else
            RANGE="${PREV_TAG}..HEAD"
          fi

          echo "Generating changelog for range: ${RANGE}"

          # Extract merge commit messages (from PRs)
          PR_CHANGES=$(git log ${RANGE} --merges --pretty=format:"- %s" 2>/dev/null | grep -v "Bump version" | grep -v "^$" || true)

          # Extract regular commit messages (non-merge, non-bump)
          COMMIT_CHANGES=$(git log ${RANGE} --no-merges --pretty=format:"- %s" 2>/dev/null | grep -v "Bump version" | grep -v "^$" || true)

          # Combine: prefer PR messages, fall back to commits
          if [ -n "$PR_CHANGES" ]; then
            CHANGES="$PR_CHANGES"
          elif [ -n "$COMMIT_CHANGES" ]; then
            CHANGES="$COMMIT_CHANGES"
          else
            CHANGES="- Bug fixes and improvements"
          fi

          # Write to output (multiline)
          {
            echo "changes<<CHANGELOG_EOF"
            echo "$CHANGES"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump.outputs.tag }}
          name: ECU File Organizer ${{ steps.bump.outputs.tag }}
          body: |
            ## ECU File Organizer v${{ steps.bump.outputs.new }}

            ### Download
            Download and run `ECU_File_Organizer_v${{ steps.bump.outputs.new }}.exe` - no installation required.

            ### Changes
            ${{ steps.changelog.outputs.changes }}
          files: dist/*.exe
