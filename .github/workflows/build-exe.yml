name: Build & Release EXE

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute next version from tags
        id: bump
        shell: bash
        run: |
          LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            NEW="1.0"
          else
            OLD="${LATEST_TAG#v}"
            MAJOR=$(echo "$OLD" | cut -d. -f1)
            MINOR=$(echo "$OLD" | cut -d. -f2)
            NEW="${MAJOR}.$((MINOR + 1))"
          fi
          echo "Version: $NEW (previous tag: $LATEST_TAG)"
          echo "new=$NEW" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEW" >> "$GITHUB_OUTPUT"

      - name: Inject version into C# source
        shell: python
        run: |
          import re
          version = "${{ steps.bump.outputs.new }}"

          with open("src/Constants.cs") as f:
              content = f.read()
          content = re.sub(r'AppVersion\s*=\s*"[^"]*"', f'AppVersion = "{version}"', content)
          with open("src/Constants.cs", "w") as f:
              f.write(content)

          with open("src/Properties/AssemblyInfo.cs") as f:
              content = f.read()
          content = re.sub(r'AssemblyVersion\("[^"]*"\)', f'AssemblyVersion("{version}.0.0")', content)
          content = re.sub(r'AssemblyFileVersion\("[^"]*"\)', f'AssemblyFileVersion("{version}.0.0")', content)
          with open("src/Properties/AssemblyInfo.cs", "w") as f:
              f.write(content)

          print(f"Injected version {version} into C# sources (build only, not committed)")

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.bump.outputs.tag }}
          git push origin ${{ steps.bump.outputs.tag }}

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet packages
        run: nuget restore ECUFileOrganizer.sln

      - name: Build Release
        run: msbuild src/ECUFileOrganizer.csproj /p:Configuration=Release /p:OutputPath=..\build

      - name: Rename EXE with version
        run: |
          mkdir dist
          move build\ECU_File_Organizer.exe "dist\ECU_File_Organizer_v${{ steps.bump.outputs.new }}.exe"
        shell: cmd

      - name: Show EXE size
        run: dir dist\*.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ECU_File_Organizer_v${{ steps.bump.outputs.new }}
          path: dist/*.exe

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          CURRENT_TAG="${{ steps.bump.outputs.tag }}"
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n 1)

          if [ -z "$PREV_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${PREV_TAG}..HEAD"
          fi

          echo "Generating changelog for range: ${RANGE}"

          PR_CHANGES=$(git log ${RANGE} --merges --pretty=format:"- %s" 2>/dev/null | grep -v "Bump version" | grep -v "^$" || true)
          COMMIT_CHANGES=$(git log ${RANGE} --no-merges --pretty=format:"- %s" 2>/dev/null | grep -v "Bump version" | grep -v "^$" || true)

          if [ -n "$PR_CHANGES" ]; then
            CHANGES="$PR_CHANGES"
          elif [ -n "$COMMIT_CHANGES" ]; then
            CHANGES="$COMMIT_CHANGES"
          else
            CHANGES="- Bug fixes and improvements"
          fi

          {
            echo "changes<<CHANGELOG_EOF"
            echo "$CHANGES"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump.outputs.tag }}
          name: ECU File Organizer ${{ steps.bump.outputs.tag }}
          body: |
            ## ECU File Organizer v${{ steps.bump.outputs.new }}

            ### Download
            Download and run `ECU_File_Organizer_v${{ steps.bump.outputs.new }}.exe` â€” no installation required.

            > Requires Windows 10 or later (.NET Framework 4.8)

            ### Changes
            ${{ steps.changelog.outputs.changes }}
          files: dist/*.exe
